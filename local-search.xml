<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>NullPointerException</title>
    <link href="/2023/04/03/NullPointException/"/>
    <url>/2023/04/03/NullPointException/</url>
    
    <content type="html"><![CDATA[<h1 id="Stream中toMap的NullPointerException"><a href="#Stream中toMap的NullPointerException" class="headerlink" title="Stream中toMap的NullPointerException"></a>Stream中toMap的NullPointerException</h1><h2 id="问题现象"><a href="#问题现象" class="headerlink" title="问题现象"></a>问题现象</h2><p>今天测试在测试代码时，发现Collectors.toMap报了空指针异常，具体报错信息如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java.lang.NullPointerException">at java.util.HashMap.merge(HashMap.java:1225)<br>at java.util.stream.Collectors.lambda$toMap$58(Collectors.java:1320)<br>at java.util.stream.ReduceOps$3ReducingSink.accept(ReduceOps.java:169)<br>at java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1382)<br>at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:481)<br>at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:471)<br>at java.util.stream.ReduceOps$ReduceOp.evaluateSequential(ReduceOps.java:708)<br>at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)<br>at java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:499)<br>at org.mango.AppTest.shouldAnswerWithTrue(AppTest.java:26)<br>at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)<br>at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)<br>at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)<br>at java.lang.reflect.Method.invoke(Method.java:498)<br>at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:59)<br>at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)<br>at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:56)<br>at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)<br>at org.junit.runners.ParentRunner$3.evaluate(ParentRunner.java:306)<br>at org.junit.runners.BlockJUnit4ClassRunner$1.evaluate(BlockJUnit4ClassRunner.java:100)<br>at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:366)<br>at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:103)<br>at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:63)<br>at org.junit.runners.ParentRunner$4.run(ParentRunner.java:331)<br>at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:79)<br>at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:329)<br>at org.junit.runners.ParentRunner.access$100(ParentRunner.java:66)<br>at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:293)<br>at org.junit.runners.ParentRunner$3.evaluate(ParentRunner.java:306)<br>at org.junit.runners.ParentRunner.run(ParentRunner.java:413)<br>at org.junit.runner.JUnitCore.run(JUnitCore.java:137)<br>at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:68)<br>at com.intellij.rt.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:33)<br>at com.intellij.rt.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:230)<br>at com.intellij.rt.junit.JUnitStarter.main(JUnitStarter.java:58)<br></code></pre></td></tr></table></figure><p>根据提示是HashMap.merge方法报的错，经过debug，发现Stream中toMap不允许key和value为null。而正常的Map,value是可以为空的，受了经验主义的影响</p><h2 id="问题定位"><a href="#问题定位" class="headerlink" title="问题定位"></a>问题定位</h2><p>toMap源码如下，可看到内部调用了map的merge方法</p><figure class="highlight plaintext"><figcaption><span>static <T, k, u, m extends map<k, u>></T,></span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs public">Collector&lt;T, ?, M&gt; toMap(Function&lt;? super T, ? extends K&gt; keyMapper,<br>                            Function&lt;? super T, ? extends U&gt; valueMapper,<br>                            BinaryOperator&lt;U&gt; mergeFunction,<br>                            Supplier&lt;M&gt; mapSupplier) &#123;<br>    BiConsumer&lt;M, T&gt; accumulator<br>            = (map, element) -&gt; map.merge(keyMapper.apply(element),<br>                                          valueMapper.apply(element), mergeFunction);<br>    return new CollectorImpl&lt;&gt;(mapSupplier, accumulator, mapMerger(mergeFunction), CH_ID);<br>&#125;<br></code></pre></td></tr></table></figure><p>继续进入merge方法<br><img src="/2023/04/03/NullPointException/20230403230926.png"><br>可以看到value为空时，直接抛空指针异常</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>知道了原因，解决方法也就可以实现了，在collect之前，先对数据进行过滤<br>.filter(t -&gt; t.getAuthor() !&#x3D; null)<br>然后再转成map，就不会报空指针</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/2022/10/25/hello-world/"/>
    <url>/2022/10/25/hello-world/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    <categories>
      
      <category>Hexo</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
